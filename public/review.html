<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><title>The Quick Reviewer</title>
  <style>
    body{font-family:-apple-system,BlinkMacSystemFont,"Segoe UI",Roboto,Helvetica,Arial,sans-serif;background-color:#212529;color:#e9ecef;padding:2rem;max-width:800px;margin:auto;line-height:1.6}
    h1{color:#fff;margin-bottom:.25rem}
    .sub{color:#adb5bd;font-size:.95rem;margin:0 0 1rem 0}
    .review-box{background:#343a40;padding:1.5rem 2rem;border-radius:12px;border:1px solid #495057;margin-top:1.5rem;white-space:pre-line;text-align:justify}
    .loading{color:#ced4da}.err{color:#ff8c8c}strong{color:#fff;font-weight:600}
    .controls{margin-top:2rem;text-align:center}
    #refresh-btn{background-color:#495057;color:#e9ecef;border:1px solid #6c757d;padding:10px 20px;font-size:1rem;border-radius:8px;cursor:pointer;transition:background-color .2s}
    #refresh-btn:hover{background-color:#6c757d}
    #refresh-btn:disabled{background-color:#343a40;color:#6c757d;cursor:not-allowed}

    /* --- THE FIX: Styles for the new Rating Tooltip and Modal --- */
    .tooltip-trigger {
      display: inline-block;
      background-color: #495057;
      color: #e9ecef;
      border-radius: 50%;
      width: 18px;
      height: 18px;
      line-height: 18px;
      text-align: center;
      font-size: 14px;
      font-weight: bold;
      cursor: pointer;
      user-select: none;
      transition: background-color 0.2s;
    }
    .tooltip-trigger:hover { background-color: #6c757d; }
    
    .modal-overlay {
      display: none;
      position: fixed;
      z-index: 1000;
      left: 0; top: 0;
      width: 100%; height: 100%;
      background-color: rgba(0, 0, 0, 0.7);
      justify-content: center;
      align-items: center;
    }
    .modal-content {
      background-color: #343a40;
      padding: 2rem;
      border: 1px solid #495057;
      border-radius: 12px;
      max-width: 500px;
      width: 90%;
      position: relative;
    }
    .modal-close {
      position: absolute;
      top: 10px; right: 20px;
      color: #adb5bd;
      font-size: 28px;
      font-weight: bold;
      cursor: pointer;
    }
    .modal-close:hover { color: #fff; }
    .modal-content h2 { margin-top: 0; }
    .modal-content ul { padding-left: 20px; }
    .modal-content li { margin-bottom: 0.5rem; }

    /* THE FIX: Add styles for smaller screens */
    @media (max-width: 600px) {
      body { padding: 1rem; }
      .review-box { padding: 1.5rem; }
    }
  </style>
</head>
<body>
  <h1>⚡ Quick AI Review</h1>
  <p id="meta" class="sub"></p>
  <p id="loading" class="loading">Loading review...</p>
  <div id="review" class="review-box" style="display:none;"></div>
  <div class="controls">
    <button id="refresh-btn" style="display:none;">Force New Review</button>
  </div>

  <!-- THE FIX: Add the hidden modal structure to the page -->
  <div id="ratingModal" class="modal-overlay">
    <div class="modal-content">
      <span class="modal-close" onclick="closeModal()">&times;</span>
      <h2>Rating Scale</h2>
      <ul>
        <li><strong>9–10:</strong> Exceptional, rare masterpiece</li>
        <li><strong>7–8:</strong> Strong, worth watching despite flaws</li>
        <li><strong>5–6:</strong> Average, watchable but forgettable</li>
        <li><strong>3–4:</strong> Weak, major flaws outweigh positives</li>
        <li><strong>1–2:</strong> Poor, barely redeemable</li>
        <li><strong>0:</strong> Unwatchable, complete failure</li>
      </ul>
    </div>
  </div>
  
  <script>
    (function(){
      const params=new URLSearchParams(window.location.search);
      const type=(params.get('type')||'').trim();
      const id=(params.get('id')||'').trim();
      const isForced = params.has('force');
      const metaEl=document.getElementById('meta');
      const loadingEl=document.getElementById('loading');
      const reviewBox=document.getElementById('review');
      const refreshBtn=document.getElementById('refresh-btn');

      if(!type||!id){loadingEl.className='err';loadingEl.textContent='Missing parameters.';return}
      metaEl.textContent=`Type: ${type} • ID: ${id}`;
      if (isForced) { loadingEl.textContent = 'Forcing a new review from the AI, please wait...'; }

      const today=new Date().toISOString().split('T')[0];
      const url=`/api/review?type=${encodeURIComponent(type)}&id=${encodeURIComponent(id)}&date=${encodeURIComponent(today)}${isForced ? '&force=true' : ''}`;

      fetch(url).then(res=>{if(!res.ok)throw new Error(`Failed to fetch review (HTTP ${res.status})`);return res.json()}).then(data=>{
        loadingEl.style.display='none';
        const rawText=(data&&typeof data.review==='string')?data.review.trim():'';
        
        // Handle bolding with asterisks
        let formattedHtml = rawText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
        // Handle list items starting with a hyphen or asterisk
        formattedHtml = formattedHtml.replace(/^\s*([*-])\s/gm, '&bull; ');
        
        reviewBox.innerHTML = formattedHtml || 'No review available.';
        reviewBox.style.display='block';
        refreshBtn.style.display='inline-block';
      }).catch(err=>{
        loadingEl.className='err';
        loadingEl.textContent='Error: '+(err&&err.message?err.message:'Unknown error');
        refreshBtn.style.display='inline-block';
      });

      fetch(`/api/review?type=${encodeURIComponent(type)}&id=${encodeURIComponent(id)}&force=${params.has('force')}`)
        .then(res => { if(!res.ok) throw new Error(`Failed to fetch (HTTP ${res.status})`); return res.json() })
        .then(data => {
          loadingEl.style.display = 'none';
          const rawText = (data && typeof data.review === 'string') ? data.review.trim() : '';
         
          let formattedHtml = rawText.replace(/\*\*(.*?)\*\*/g, '<strong>$1</strong>');
          formattedHtml = formattedHtml.replace(/^\s*([*-])\s/gm, '&bull; ');

          // THE FIX: Use a robust regular expression to find and replace the placeholder.
          // g = global (replace all instances), i = case-insensitive
          const finalHtml = formattedHtml.replace(
            /RATING_CONTEXT/gi, 
            '<span class="tooltip-trigger" onclick="openModal()">?</span>'
          );
          
          reviewBox.innerHTML = finalHtml || 'No review available.';
          reviewBox.style.display = 'block';
          refreshBtn.style.display = 'inline-block';
        }).catch(err => {
          loadingEl.className = 'err';
          loadingEl.textContent = 'Error: ' + (err && err.message ? err.message : 'Unknown error');
          refreshBtn.style.display = 'inline-block';
        });

      refreshBtn.addEventListener('click', () => {
        const newUrl = new URL(window.location.href);
          newUrl.searchParams.set('force', 'true');
          window.location.href = newUrl.href;
      });
    })();

    /* --- THE FIX: JavaScript functions to control the modal --- */
    const modal = document.getElementById('ratingModal');

    function openModal() {
      modal.style.display = 'flex';
    }

    function closeModal() {
      modal.style.display = 'none';
    }

    // Close the modal if the user clicks on the dark overlay area
    window.onclick = function(event) {
      if (event.target == modal) {
        closeModal();
      }
    }
  </script>
</body>
</html>
