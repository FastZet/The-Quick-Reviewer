<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><title>The Quick Reviewer</title>
  <link rel="stylesheet" href="/css/global.css">
  <link rel="stylesheet" href="/css/review.css">
  <link rel="apple-touch-icon" sizes="180x180" href="/assets/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon-16x16.png">
  <link rel="manifest" href="/assets/site.webmanifest">
</head>
<body class="review-page">
  <div class="page-container">
    <div class="title-bar">
      <div class="title-group">
      <h1>⚡ Quick AI Review</h1>
      <p id="meta" class="sub"></p>
      </div>
      <div id="controls-top" class="controls-top">
        <select id="language-select" class="control-select">
          <option value="en">English</option>
          <option value="zh-CN">Chinese (Simplified)</option>
          <option value="es">Spanish</option>
          <option value="hi">Hindi</option>
          <option value="ar">Arabic</option>
          <option value="pt">Portuguese</option>
          <option value="bn">Bengali</option>
          <option value="ru">Russian</option>
          <option value="ja">Japanese</option>
          <option value="de">German</option>
          <option value="fr">French</option>
          <option value="ko">Korean</option>
          <option value="tr">Turkish</option>
          <option value="it">Italian</option>
          <option value="nl">Dutch</option>
          <option value="pl">Polish</option>
          <option value="sv">Swedish</option>
          <option value="fi">Finnish</option>
          <option value="id">Indonesian</option>
          <option value="vi">Vietnamese</option>
        </select>
        <button id="translate-btn" class="control-btn">Translate</button>
        <button id="refresh-btn" class="control-btn refresh" title="Generate a new AI review">⟳</button>
      </div>
    </div>

    <p id="loading" class="loading" {{LOADING_STATE}}>Loading review...</p>
    <div id="review" class="review-box" style="display: block;">{{REVIEW_CONTENT}}</div>
  </div>

  <script>
    (function(){
      const isTranslated = window.location.hostname.endsWith('.translate.goog');
      if (isTranslated) document.body.classList.add('translated-view');
      
      const params = new URLSearchParams(window.location.search);
      const type = (params.get('type') || '').trim();
      const id = (params.get('id') || '').trim();
      
      const metaEl = document.getElementById('meta');
      const controlsTop = document.getElementById('controls-top');
      const refreshBtn = document.getElementById('refresh-btn');
      const translateBtn = document.getElementById('translate-btn');
      const languageSelect = document.getElementById('language-select');

      if (isTranslated) {
        controlsTop.style.display = 'none';
        const banner = document.createElement('div');
        banner.className = 'translated-banner';
        let originalUrl = '#';
        try {
            const translatedUrlParams = new URLSearchParams(window.location.search);
            const originalUrlParam = translatedUrlParams.get('u');
            if (originalUrlParam) originalUrl = originalUrlParam;
        } catch (e) { console.error('Could not parse original URL'); }
        banner.innerHTML = 'You are viewing a translated version. Interactive features are disabled. <a href="' + originalUrl + '">View Original</a>';
        document.querySelector('.page-container').prepend(banner);
      }

      metaEl.textContent = `Type: ${type} • ID: ${id}`;
      
      if (!isTranslated) setupAccordion();
      
      translateBtn.addEventListener('click', () => {
        const targetLanguage = languageSelect.value;
        
        // --- Clean the URL before sending to Google Translate ---
        const cleanUrl = new URL(window.location.href);
        cleanUrl.searchParams.delete('force');
        
        const translateUrl = new URL('https://translate.google.com/translate');
        translateUrl.searchParams.set('sl', 'auto');
        translateUrl.searchParams.set('tl', targetLanguage);
        translateUrl.searchParams.set('u', cleanUrl.href);
        
        window.open(translateUrl.href, '_blank');
      });

      refreshBtn.addEventListener('click', () => {
        refreshBtn.disabled = true;
        refreshBtn.textContent = 'Refreshing...';
        const newUrl = new URL(window.location.href);
        newUrl.searchParams.set('force', 'true');
        window.location.href = newUrl.href;
      });

      function setupAccordion() {
        const accordion = document.querySelector('#review .accordion');
        if (!accordion) return;
        const initiallyActiveItem = accordion.querySelector('.accordion-item.active');
        if (initiallyActiveItem) {
          const content = initiallyActiveItem.querySelector('.accordion-content');
          setTimeout(() => { content.style.maxHeight = content.scrollHeight + 'px'; }, 0);
        }
        accordion.addEventListener('click', (e) => {
          const header = e.target.closest('.accordion-header');
          if (!header) return;
          const currentItem = header.parentElement;
          const currentContent = header.nextElementSibling;
          const currentlyActiveItem = accordion.querySelector('.accordion-item.active');
          if (currentlyActiveItem && currentlyActiveItem !== currentItem) {
            currentlyActiveItem.classList.remove('active');
            currentlyActiveItem.querySelector('.accordion-content').style.maxHeight = null;
          }
          currentItem.classList.toggle('active');
          if (currentItem.classList.contains('active')) {
            currentContent.style.maxHeight = currentContent.scrollHeight + 'px';
          } else {
            currentContent.style.maxHeight = null;
          }
        });
      }
    })();
  </script>
</body>
</html>
