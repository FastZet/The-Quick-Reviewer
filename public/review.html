<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" /><meta name="viewport" content="width=device-width, initial-scale=1.0" /><title>The Quick Reviewer</title>
  <link rel="stylesheet" href="/css/global.css">
  <link rel="stylesheet" href="/css/review.css">
  <link rel="apple-touch-icon" sizes="180x180" href="/assets/apple-touch-icon.png">
  <link rel="icon" type="image/png" sizes="32x32" href="/assets/favicon-32x32.png">
  <link rel="icon" type="image/png" sizes="16x16" href="/assets/favicon-16x16.png">
  <link rel="manifest" href="/assets/site.webmanifest">
</head>
<body class="review-page">
  <div class="page-container">
    <div class="title-bar">
      <h1>⚡ Quick AI Review</h1>
      <div id="controls-top" class="controls-top">
        <select id="language-select" class="control-select" style="display:none;">
          <option value="en">English</option>
          <option value="es">Spanish</option>
          <option value="fr">French</option>
          <option value="de">German</option>
          <option value="hi">Hindi</option>
          <option value="it">Italian</option>
          <option value="ja">Japanese</option>
          <option value="ko">Korean</option>
          <option value="pt">Portuguese</option>
          <option value="ru">Russian</option>
          <option value="zh-CN">Chinese (Simplified)</option>
        </select>
        <button id="translate-btn" class="control-btn" style="display:none;">Translate</button>
        <button id="refresh-btn" class="control-btn refresh" style="display:none;" title="Force a new AI review to be generated">⟳</button>
      </div>
    </div>

    <p id="meta" class="sub"></p>
    <p id="loading" class="loading">Loading review...</p>
    <div id="review" class="review-box" style="display:none;"></div>
  </div>

  <div id="ratingModal" class="modal-overlay">
    <div class="modal-content">
      <span class="modal-close" onclick="closeModal()">&times;</span>
      <h2>Rating Scale</h2>
      <ul>
        <li><strong>9–10:</strong> Exceptional, rare masterpiece</li>
        <li><strong>7–8:</strong> Strong, worth watching despite flaws</li>
        <li><strong>5–6:</strong> Average, watchable but forgettable</li>
        <li><strong>3–4:</strong> Weak, major flaws outweigh positives</li>
        <li><strong>1–2:</strong> Poor, barely redeemable</li>
        <li><strong>0:</strong> Unwatchable, complete failure</li>
      </ul>
    </div>
  </div>
  
  <script>
    (function(){
      const isTranslated = window.location.hostname.endsWith('.translate.goog');

      if (isTranslated) {
        document.body.classList.add('translated-view');
      }
      
      const params = new URLSearchParams(window.location.search);
      const type = (params.get('type') || '').trim();
      const id = (params.get('id') || '').trim();
      const isForced = params.has('force');
      
      const metaEl = document.getElementById('meta');
      const loadingEl = document.getElementById('loading');
      const reviewBox = document.getElementById('review');
      
      const controlsTop = document.getElementById('controls-top');
      const refreshBtn = document.getElementById('refresh-btn');
      const translateBtn = document.getElementById('translate-btn');
      const languageSelect = document.getElementById('language-select');

      if (isTranslated) {
        controlsTop.style.display = 'none';
        const banner = document.createElement('div');
        banner.className = 'translated-banner';
        banner.innerHTML = 'You are viewing a translated version. Interactive features are disabled. <a href="' + window.location.href.replace(window.location.hostname, new URLSearchParams(window.location.search).get('u').split('/')[2]) + '">View Original</a>';
        document.querySelector('.page-container').prepend(banner);
      }

      if (!type || !id) {
        loadingEl.className = 'err';
        loadingEl.textContent = 'Missing parameters.';
        return;
      }
      
      metaEl.textContent = `Type: ${type} • ID: ${id}`;
      if (isForced) { loadingEl.textContent = 'Forcing a new review from the AI, please wait...'; }
      
      const basePath = window.location.pathname.replace('/review', '');
      const apiUrl = `${basePath}/api/review`;
      const url = `${apiUrl}?type=${encodeURIComponent(type)}&id=${encodeURIComponent(id)}${isForced ? '&force=true' : ''}`;
      
      fetch(url)
        .then(res => {
          if (!res.ok) throw new Error(`Failed to fetch review (HTTP ${res.status})`);
          return res.json();
        })
        .then(data => {
          loadingEl.style.display = 'none';
          const reviewHtml = (data && data.review) ? data.review : '<p>No review available.</p>';
          reviewBox.innerHTML = reviewHtml;
          reviewBox.style.display = 'block';
          
          if (!isTranslated) {
            setupAccordion();
          }
          
          setupRatingTooltip();
          
          if (!isTranslated) {
            refreshBtn.style.display = 'flex';
            translateBtn.style.display = 'flex';
            languageSelect.style.display = 'flex';
          }
        })
        .catch(err => {
          loadingEl.className = 'err';
          loadingEl.textContent = 'Error: ' + (err && err.message ? err.message : 'Unknown error');
          if (!isTranslated) {
            refreshBtn.style.display = 'flex';
          }
        });
      
      translateBtn.addEventListener('click', () => {
        const targetLanguage = languageSelect.value;
        const currentPageUrl = window.location.href;
        
        const translateUrl = new URL('https://translate.google.com/translate');
        translateUrl.searchParams.set('sl', 'auto');
        translateUrl.searchParams.set('tl', targetLanguage);
        translateUrl.searchParams.set('u', currentPageUrl);
        
        window.open(translateUrl.href, '_blank');
      });

      refreshBtn.addEventListener('click', () => {
        refreshBtn.disabled = true;
        refreshBtn.textContent = 'Refreshing...';
        const newUrl = new URL(window.location.href);
        newUrl.searchParams.set('force', 'true');
        window.location.href = newUrl.href;
      });

      function setupRatingTooltip() {
        const placeholder = reviewBox.querySelector('#rating-context-placeholder');
        if (!placeholder) return;
        const button = document.createElement('span');
        button.className = 'tooltip-trigger';
        button.textContent = '?';
        if (!isTranslated) button.addEventListener('click', openModal);
        const space = document.createTextNode('\u00A0');
        placeholder.parentNode.replaceChild(button, placeholder);
        button.parentNode.insertBefore(space, button);
      }

      function setupAccordion() {
        const accordion = reviewBox.querySelector('.accordion');
        if (!accordion) return;
        const initiallyActiveItem = accordion.querySelector('.accordion-item.active');
        if (initiallyActiveItem) {
          const content = initiallyActiveItem.querySelector('.accordion-content');
          setTimeout(() => { content.style.maxHeight = content.scrollHeight + 'px'; }, 0);
        }
        accordion.addEventListener('click', (e) => {
          const header = e.target.closest('.accordion-header');
          if (!header) return;
          const currentItem = header.parentElement;
          const currentContent = header.nextElementSibling;
          const currentlyActiveItem = accordion.querySelector('.accordion-item.active');
          if (currentlyActiveItem && currentlyActiveItem !== currentItem) {
            currentlyActiveItem.classList.remove('active');
            currentlyActiveItem.querySelector('.accordion-content').style.maxHeight = null;
          }
          currentItem.classList.toggle('active');
          if (currentItem.classList.contains('active')) {
            currentContent.style.maxHeight = currentContent.scrollHeight + 'px';
          } else {
            currentContent.style.maxHeight = null;
          }
        });
      }
    })();

    const modal = document.getElementById('ratingModal');
    function openModal() { modal.style.display = 'flex'; }
    function closeModal() { modal.style.display = 'none'; }
    window.onclick = function(event) { if (event.target == modal) { closeModal(); } }
  </script>
</body>
</html>
